@using System.Security.Claims;
@{
    var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
    var userName = User.FindFirst(ClaimTypes.UserData)?.Value;
}
@if (User.Identity.IsAuthenticated && userRole != "Quản lý" && User.Identity.IsAuthenticated && userRole != "Nhân viên")
{
    Layout = null;
    <partial name="../Shared/404Error.cshtml" />
    return;
}@using System.Security.Claims
@inject ApplicationDbContext _db;
@model List<QuanLyKhachSan.Models.DatPhong>
@{
    ViewData["Title"] = "Quản lý đặt phòng";
}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Add custom CSS or additional stylesheets here -->
    <!-- (Include additional head elements) -->
    <style>
        .popup-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(66, 64, 64, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .popup-content {
            width: 100%;
            height: 80%;
            max-width: 60vw;
            /* Giới hạn chiều rộng tối đa */
            background-color: white;
            padding: 25px;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 130vw;
            /* hoặc giá trị phù hợp khác */
            overflow-y: auto;
        }

        .close-icon {
            position: absolute;
            font-size: 20px;
            top: 5px;
            right: 10px;
            cursor: pointer;
        }

        .popup button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* CSS để tạo popup */
        .overlayDV {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Mờ đen với độ trong suốt 0.5 */
            z-index: 1;
        }

        .popupDV {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            z-index: 2;
            max-height: 80%; /* Đặt chiều cao tối đa để tránh tràn màn hình */
            overflow-y: auto;
            /* Z-index lớn hơn so với lớp mờ */
        }

        .form-popup {
            display: none;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }

        .form-container {
            max-width: 100%;
            padding: 10px;
            background-color: white;
        }
    </style>
</head>

<body>

    <!-- Breadcrumb and other structural elements if needed -->
    <div class="mt-3">
        <section>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Tổng quan</a></li>
                <li class="breadcrumb-item active" aria-current="page">Quản lý đặt phòng</li>
            </ol>
        </section>


        <div class="form-popup mb-2" id="myForm">
            <form class="form-container" id="myFormContainer">
                <h1 style="font-family:Roboto;">Sửa đặt phòng</h1>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Mã đặt phòng</label>
                            <input class="form-control" name="maphong" id="inputFieldMaDatPhong" maxlength="6" readonly/>
                            <span id="errorMaP" style="color: red;"></span>
                        </div>
                        <div class="form-group">
                            <label>Mã phòng</label>
                            <input class="form-control" name="maloaiphong" id="inputFieldMaPhong" readonly/>
       
                            <span id="errorChonLP" style="color: red;"></span>
                        </div>

                        <div class="form-group">
                            <label>Mã khách hàng</label>
                            <input class="form-control" name="ngaytao" type="text" id="inputFieldMaKhachHang" readonly/>
                            <span id="errorNgayTao" style="color: red;"></span>
                        </div>
                        <div class="form-group">
                            <label>Tình trạng</label>
                            <select class="form-control" name="tinhTrang"  id="inputFieldTinhTrang" >
                                <option value="Đã được duyệt">Đã được duyệt</option>
                                <option value="Chờ check in">Chờ check in</option>
                                <option value="Đang ở">Đang ở</option>
                                <option value="Chờ check out">Chờ check out</option>
                            </select>
                           
                            <span id="errorNgayTao" style="color: red;"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Ngày nhận</label>
                            <input class="form-control" name="maphong" id="inputFieldNgayNhan"  type="datetime-local" readonly />
                            <span id="errorNgayNhan" style="color: red;"></span>
                        </div>
                        <div class="form-group">
                            <label>Ngày trả</label>
                            <input class="form-control" name="maloaiphong" id="inputFieldNgayTra" type="datetime-local"/>
                            
                            <span id="errorNgayTra" style="color: red;"></span>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label>Sl Người lớn</label>
                                <input class="form-control" name="soLuongNguoiLon" 
                                       id="inputFieldSoLuongNguoiLon" type="number" min="1" required onkeypress="return event.charCode >= 48" onblur="if(this.value=='' || this.value==0){this.value='1'}"  />


                                <span id="errorSoLuongNguoiLon" style="color: red;"></span>
                            </div>
                            <div class="col-md-6">
                                <label>Sl Trẻ em</label>
                                <input class="form-control" name="soLuongTreEm" type="number" min="0" required onkeypress="return event.charCode >= 48" onblur="if(this.value=='' ){this.value='0'}"
                                       id="inputFieldSoLuongTreEm" />
                                <span id="errorSoLuongTreEm" style="color: red;"></span>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Hình thức đặt phòng</label>
                            @* <input class="form-control" name="maphong" id="inputFieldHinhThucDatPhong" maxlength="6" /> *@
                            <select class="form-control" name="maphong" id="inputFieldHinhThucDatPhong">
                                <option value="Giờ">Giờ</option>
                                <option value="Ngày">Ngày</option>
                            </select>
                            <span id="errorMaP" style="color: red;"></span>
                        </div>
                        <div class="form-group" hidden>
                            <label>Tổng tiền phòng</label>
                            <input class="form-control" name="maloaiphong" id="inputFieldTongTienPhong" readonly/>
                   
                            <span id="errorChonLP" style="color: red;"></span>
                        </div>
                        <div class="form-group" >
                            <label>Tiền khách trả trước</label>
                            <input class="form-control" name="maloaiphong" id="inputFieldKhachTraTruoc" type="number" min="0" required onkeypress="return event.charCode >= 48" onblur="if(this.value=='' ){this.value='0'}" />

                            <span id="errorChonLP" style="color: red;"></span>
                        </div>

                        <div class="form-group">
                            <label>Mã nhân viên</label>
                            <input class="form-control" name="ngaytao" type="text" id="inputFieldMaNhanVien" readonly/>
                            <span id="errorNgayTao" style="color: red;"></span>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div id="ChonDichVu" class="mt-4">
                        </div>
                        <button type="button" class="btn btn-outline-success" id="AddThemDichVu">
                            <i class="bi bi-plus"></i> Thêm dịch vụ
                        </button>
                    </div>
                    <div class="col-md-4">
                        <label>Tiền phòng</label>
                        <span id="TongTienPhong">0.00</span>
                        <br />
                        <label>Tiền dịch vụ</label>
                        <span id="TongTienDichVuDaDat">0.00</span>
                        <br />
                        <label>Tổng tiền</label>
                        <span id="TongTien">0.00</span>
                        <div id="TongDichVuDaDat" style="display:none;"></div>

                    </div>
                    <div class="col-md-4">
                    </div>
                    <div class="col-md-4">
                    </div>
                </div>

                <div class="clearfix">
                    <button type="submit" class="btn align-middle m-2 w-25 btn-success " style="min-width:200px" 
                            onclick="SuaDatPhong()">
                        Sửa đặt phòng
                    </button>
                    <button type="button" class="btn btn-danger align-middle m-2 w-0  cancel"
                            onclick="closeForm()">
                        Đóng
                    </button>
                </div>
            </form>
        </div>

        <div class="row">
            <div class="col-sm-4">
            </div>
            <div class="col-sm-6">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="Tìm kiếm">
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="table_detail" style="border:1px solid #343A40">   
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Mã đặt phòng</th>
                        <th scope="col">Khách hàng</th>
                        <th scope="col">Phòng</th>
                        <th scope="col">Ngày nhận</th>
                        <th scope="col">Ngày trả</th>
                        <th scope="col">Số lượng người lớn</th>
                        <th scope="col">Số lượng trẻ em</th>
                        <th scope="col">Hình thức đặt</th>
                        <th scope="col">Dịch vụ</th>
                        <th scope="col">Tổng tiền phòng</th>
                        <th scope="col">Nhân viên phụ trách</th>
                        <th scope="col">Tình trạng</th>
                        <th scope="col">Số tiền trả trước</th>

                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody>

                  @{
                        var stt = 0;
                    }
                    @foreach (var item in Model)
                    {
                        stt = stt + 1;
                        <tr>
                            <td scope="row">@stt</td>
                            <th>@Html.DisplayFor(m => item.MaDatPhong)</th>
                            <td>@Html.DisplayFor(m => item.MaKhachHang)</td>
                            <td>@Html.DisplayFor(m => item.MaPhong)</td>
                            <td>@Html.DisplayFor(m => item.NgayNhan)</td>
                            <td>@Html.DisplayFor(m => item.NgayTra)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongNguoiLon)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongTreEm)</td>
                            <td>@Html.DisplayFor(m => item.HinhThucDatPhong)</td>
                        <td>
                              
                            <a href="#" onclick="openPopup('@item.MaDatPhong')">Chi tiết</a>
                           
                        </td>
                            <td>@Html.DisplayFor(m => item.TongTienPhong)</td>
                            <td>@Html.DisplayFor(m => item.MaNhanVien)</td>
                            <td>@Html.DisplayFor(m => item.TinhTrang)</td>
                            <td>@Html.DisplayFor(m => item.SoTienTraTruoc)</td>
                        <td>
                                <button class="btn btn-primary btn-sm" id="btn_suaPhong" onclick="HienThiThongTinDatPhong('@item.MaDatPhong')">
                                Sửa
                            </button>

                            <button type="submit" class="btn btn-danger btn-sm" onclick="XoaDatPhong('@item.MaDatPhong')">
                                Xóa
                            </button>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
             @foreach (var item in Model)
                    {
             <div id="overlayDV" class="overlayDV"></div>
                            <div id="myPopupDV" class="popupDV">
                                <h4>Dịch vụ phòng @item.MaPhong</h4>
                                    <table class="table">

                                        <thead>

                                            <tr>

                                                <th>Mã dịch vụ</th>

                                                <th>Tên dịch vụ</th>

                                                <th>Giá dịch vụ</th>

                                                <th>Số lượng dịch vụ</th>

                                            </tr>

                                        </thead>

                                        <tbody id="DichVuCon">
                                        </tbody>

                                    </table>
                                <a class="btn btn-danger mt-3" href="#" onclick="closePopup()">Đóng</a>
                            </div>}
        </div>
    </div>
    <script src="~/js/JsQuanLyDatPhong.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            // Sự kiện khi nhập liệu vào ô tìm kiếm
            $("#searchInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();

                // Lọc các hàng trong bảng
                $("table#table_detail tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            $('select[name="example_length"]').on('change', function () {
                var selectedValue = $(this).val();
                $('#formExample').submit();
            });
        });
    </script>

    <script>
        function openPopup(MaDatPhong) {
            var overlay = document.getElementById("overlayDV");
            var popup = document.getElementById("myPopupDV");

            overlay.style.display = "block";
            popup.style.display = "block";

            $.ajax({
                type: 'POST',
                url: '/QuanLyDatPhong/LayThongTinDichVuChiTiet',
                data: { 'MaDatPhong': MaDatPhong },
                success: function (result) {
                    var dichVuChiTietTable = $('#DichVuCon');

                    dichVuChiTietTable.empty();

                    result.dichVuChiTiet.forEach(function (item) {
                        var row = '<tr>' +
                            '<td>' + item.maDichVu + '</td>' +
                            '<td>' + item.dichVu.tenDichVu + '</td>' +
                            '<td>' + item.dichVu.giaTien + '</td>' +
                            '<td>' + item.soLuong + '</td>' +
                            '</tr>';

                        dichVuChiTietTable.append(row);
                    });
                },
                error: function () {
                }
            });
        }

        function closePopup() {
            var overlay = document.getElementById("overlayDV");
            var popup = document.getElementById("myPopupDV");

            overlay.style.display = "none";
            popup.style.display = "none";
        }

    </script>

</body>

</html>