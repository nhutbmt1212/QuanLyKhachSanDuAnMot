@using System.Security.Claims
@inject ApplicationDbContext _db;
@model List<QuanLyKhachSan.Models.DatPhong>
@{
    ViewData["Title"] = "Quản lý đặt phòng";
    var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Add custom CSS or additional stylesheets here -->
    <!-- (Include additional head elements) -->
</head>

<body>
    <!-- Breadcrumb and other structural elements if needed -->
    <div class="mt-3">
        <section>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home">Tổng quan</a></li>
                <li class="breadcrumb-item active" aria-current="page">Quản lý đặt phòng</li>
            </ol>
        </section>
        <div class="row">
            <div class="col-sm-4">

            </div>
            <div class="col-sm-6">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="Tìm kiếm">
            </div>
        </div>
        <!-- Table to display room reservations -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Mã đặt phòng</th>
                        <th scope="col">Khách hàng</th>
                        <th scope="col">Phòng</th>
                        <th scope="col">Ngày nhận</th>
                        <th scope="col">Ngày trả</th>
                        <th scope="col">Số người lớn</th>
                        <th scope="col">Số trẻ em</th>
                        <th scope="col">Hình thức đặt</th>
                        <th scope="col">Dịch vụ</th>
                        <th scope="col">Tổng tiền phòng</th>
                        <th scope="col">Nhân viên phụ trách</th>
                        <th scope="col">Tình trạng</th>
                        <th scope="col">Số tiền trả trước</th>

                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var stt = 0;
                    }
                    @foreach (var item in Model)
                    {
                        stt = stt + 1;
                        <tr>
                            <td scope="row">@stt</td>
                            <th>@Html.DisplayFor(m => item.MaDatPhong)</th>
                            <td>@Html.DisplayFor(m => item.MaKhachHang)</td>
                            <td>@Html.DisplayFor(m => item.MaPhong)</td>
                            <td>@Html.DisplayFor(m => item.NgayNhan)</td>
                            <td>@Html.DisplayFor(m => item.NgayTra)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongNguoiLon)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongTreEm)</td>
                            <td>@Html.DisplayFor(m => item.HinhThucDatPhong)</td>
                            <td>
                                <table>
                                    @{
                                        var qr_DichVuChiTiet = _db.ChiTietDichVu
                                        .Where(s => s.MaDatPhong == item.MaDatPhong)
                                        .ToList();

                                        // Assuming ChiTietDichVu contains properties named SoLuong and DonGia
                                        var maDichVuList = qr_DichVuChiTiet.Select(c => c.MaDichVu).ToList();

                                        var qr_DichVu = _db.DichVu
                                        .Where(s => maDichVuList.Contains(s.MaDichVu))
                                        .ToList();
                                    }
                                    <tr>
                                        <th>Mã dịch vụ</th>
                                        <th>Tên dịch vụ</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                    </tr>
                                    @foreach (var dichvuChiTiet in qr_DichVuChiTiet)
                                    {
                                        var dichvu = qr_DichVu.FirstOrDefault(d => d.MaDichVu == dichvuChiTiet.MaDichVu);

                                        if (dichvu != null)
                                        {
                                            <tr>
                                                <td>@dichvu.MaDichVu</td>
                                                <td>@dichvu.TenDichVu</td>
                                                <td>@dichvuChiTiet.SoLuong</td>
                                                <td>@dichvu.GiaTien</td>
                                            </tr>
                                        }
                                    }
                                </table>


                            </td>
                            <td>@Html.DisplayFor(m => item.TongTienPhong)</td>

                            <td>@Html.DisplayFor(m => item.MaNhanVien)</td>
                            <td>@Html.DisplayFor(m => item.TinhTrang)</td>
                            <td>@Html.DisplayFor(m => item.SoTienTraTruoc)</td>
                        
                                <td>
                                <button class="btn btn-primary btn-sm" onclick="editReservation('@item.MaDatPhong')">Sửa</button>

                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteReservation('@item.MaDatPhong')">
                                    Xóa
                                </button>
                                </td>
                          

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
  


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#searchInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("table tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Bắt sự kiện thay đổi giá trị trong dropdown "Show"
            $('select[name="example_length"]').on('change', function () {
                var selectedValue = $(this).val();
                $('#formExample').submit(); // Gửi biểu mẫu khi giá trị thay đổi
            });
        });
    </script>

</body>

</html>