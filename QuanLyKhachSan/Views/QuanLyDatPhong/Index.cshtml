@using System.Security.Claims
@inject ApplicationDbContext _db;
@model List<QuanLyKhachSan.Models.DatPhong>
@{
    ViewData["Title"] = "Quản lý đặt phòng";
    var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
    <style>
        .form-popup {
            display: none;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }

        .form-container {
            max-width: 100%;
            padding: 10px;
            background-color: white;
        }
    </style>

    <div class="form-popup mb-2" id="myForm">
        <form class="form-container" id="myFormContainer">
            <h1 style="font-family:Roboto;">Sửa đặt phòng</h1>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Mã đặt phòng</label>
                        <input class="form-control" name="maphong" id="inputFieldMaP" maxlength="6" />
                        <span id="errorMaP" style="color: red;"></span>
                    </div>
                    <div class="form-group">
                        <label>Mã phòng</label>
                        <select class="form-control" name="maloaiphong" id="inputFieldChonLP">
                        </select>
                        <span id="errorChonLP" style="color: red;"></span>
                    </div>

                    <div class="form-group">
                        <label>Mã khách hàng</label>
                        <input class="form-control" name="ngaytao" type="text" id="inputFieldNgayTao" />
                        <span id="errorNgayTao" style="color: red;"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Ngày nhận</label>
                        <input class="form-control" name="maphong" id="inputFieldMaP" maxlength="6" />
                        <span id="errorMaP" style="color: red;"></span>
                    </div>
                    <div class="form-group">
                        <label>Ngày trả</label>
                        <select class="form-control" name="maloaiphong" id="inputFieldChonLP">
                        </select>
                        <span id="errorChonLP" style="color: red;"></span>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-6">
                            <label>Sl Người lớn</label>
                            <input class="form-control" name="soLuongNguoiLon" type="text"
                                   id="inputFieldSoLuongNguoiLon" />
                            <span id="errorSoLuongNguoiLon" style="color: red;"></span>
                        </div>
                        <div class="col-md-6">
                            <label>Sl Trẻ em</label>
                            <input class="form-control" name="soLuongTreEm" type="text"
                                   id="inputFieldSoLuongTreEm" />
                            <span id="errorSoLuongTreEm" style="color: red;"></span>
                        </div>
                    </div>

                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Hình thức đặt phòng</label>
                        <input class="form-control" name="maphong" id="inputFieldMaP" maxlength="6" />
                        <span id="errorMaP" style="color: red;"></span>
                    </div>
                    <div class="form-group">
                        <label>Tổng tiền phòng</label>
                        <select class="form-control" name="maloaiphong" id="inputFieldChonLP">
                        </select>
                        <span id="errorChonLP" style="color: red;"></span>
                    </div>

                    <div class="form-group">
                        <label>Mã nhân viên</label>
                        <input class="form-control" name="ngaytao" type="text" id="inputFieldNgayTao" />
                        <span id="errorNgayTao" style="color: red;"></span>
                    </div>
                </div>

                <div class="col-md-12">
                    <div id="ChonDichVu" class="mt-4">
                    </div>
                    <button type="button" class="btn btn-outline-success" id="AddThemDichVu">
                        <i class="bi bi-plus"></i> Thêm dịch vụ
                    </button>
                </div>
                <div class="col-md-4">
                    <label>Tiền phòng</label>
                    <span id="TongTienPhong">0.00</span>
                    <br/>
                    <label>Tiền dịch vụ</label>
                    <span id="TongTienDichVuDaDat">0.00</span>
                    <br />
                    <label>Tổng tiền</label>
                    <span id="TongTien">0.00</span>
                    <div id="TongDichVuDaDat" style="display:none;"></div>

                </div>
                <div class="col-md-4">
                   
                </div>
                <div class="col-md-4">
                    
                </div>
            </div>

            <div class="clearfix">
                <button class="btn align-middle m-2 w-25 btn-success " style="min-width:200px" type="submit"
                        onclick="ThemPhong()">
                    Sửa đặt phòng
                </button>
                <button type="button" class="btn btn-danger align-middle m-2 w-0  cancel"
                        onclick="closeForm()">
                    Đóng
                </button>
            </div>
        </form>
    </div>
    <!-- Breadcrumb and other structural elements if needed -->
    <div class="container mt-3">
        <h2 class="mb-4">Quản lý đặt phòng</h2>
        <!-- Table to display room reservations -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Mã đặt phòng</th>
                        <th scope="col">Khách hàng</th>
                        <th scope="col">Phòng</th>
                        <th scope="col">Ngày nhận</th>
                        <th scope="col">Ngày trả</th>
                        <th scope="col">Số người lớn</th>
                        <th scope="col">Số trẻ em</th>
                        <th scope="col">Hình thức đặt</th>
                        <th scope="col">Dịch vụ</th>
                        <th scope="col">Tổng tiền phòng</th>
                        <th scope="col">Nhân viên phụ trách</th>
                        <th scope="col">Tình trạng</th>
                        <th scope="col">Số tiền trả trước</th>

                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var stt = 0;
                    }
                    @foreach (var item in Model)
                    {
                        stt = stt + 1;
                        <tr>
                            <td scope="row">@stt</td>
                            <th>@Html.DisplayFor(m => item.MaDatPhong)</th>
                            <td>@Html.DisplayFor(m => item.MaKhachHang)</td>
                            <td>@Html.DisplayFor(m => item.MaPhong)</td>
                            <td>@Html.DisplayFor(m => item.NgayNhan)</td>
                            <td>@Html.DisplayFor(m => item.NgayTra)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongNguoiLon)</td>
                            <td>@Html.DisplayFor(m => item.SoLuongTreEm)</td>
                            <td>@Html.DisplayFor(m => item.HinhThucDatPhong)</td>
                            <td>
                                <table>
                                    @{
                                        var qr_DichVuChiTiet = _db.ChiTietDichVu
                                        .Where(s => s.MaDatPhong == item.MaDatPhong)
                                        .ToList();

                                        // Assuming ChiTietDichVu contains properties named SoLuong and DonGia
                                        var maDichVuList = qr_DichVuChiTiet.Select(c => c.MaDichVu).ToList();

                                        var qr_DichVu = _db.DichVu
                                        .Where(s => maDichVuList.Contains(s.MaDichVu))
                                        .ToList();
                                    }
                                    <tr>
                                        <th>Mã dịch vụ</th>
                                        <th>Tên dịch vụ</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                    </tr>
                                    @foreach (var dichvuChiTiet in qr_DichVuChiTiet)
                                    {
                                        var dichvu = qr_DichVu.FirstOrDefault(d => d.MaDichVu == dichvuChiTiet.MaDichVu);

                                        if (dichvu != null)
                                        {
                                            <tr>
                                                <td>@dichvu.MaDichVu</td>
                                                <td>@dichvu.TenDichVu</td>
                                                <td>@dichvuChiTiet.SoLuong</td>
                                                <td>@dichvu.GiaTien</td>
                                            </tr>
                                        }
                                    }
                                </table>
                            </td>
                            <td>@Html.DisplayFor(m => item.TongTienPhong)</td>

                            <td>@Html.DisplayFor(m => item.MaNhanVien)</td>
                            <td>@Html.DisplayFor(m => item.TinhTrang)</td>
                            <td>@Html.DisplayFor(m => item.SoTienTraTruoc)</td>
                            <td>
                                <button class="btn btn-primary btn-sm" id="btn_suaPhong">Sửa đặt phòng</button>

                                <button class="btn btn-danger btn-sm" onclick="deleteReservation('@item.MaDatPhong')">
                                    Hủy đặt phòng
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>


  <script src="~/js/JsQuanLyDatPhong.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>